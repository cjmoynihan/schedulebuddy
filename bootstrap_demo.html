<!doctype html>
<html lang="en">
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

		<!-- jQuery first, then Popper.js, then Bootstrap JS -->
		<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
		
		<title>My Schedule - Schedule Buddy</title>
	</head>
	<body>
		<div class="row">
			<div class="col-sm-8">
				<h3>My Schedule</h3>
				<canvas id="calendarCanvas" width="1400" height="1200"></canvas> 
			</div>
			
			<div class="col-sm-4" id="friendPicker">
				<h3 id="friendSection">Add Friend Schedules</h3>
				<input type="text" class="form-control" id="friendNameInput">
				<button type="button" class="btn btn-primary" id="addFriendBtn">Add</button>
			</div>
		</div>
		
		<div class="row">
			<div class="col-lg-12">
				<h3>Add Event</h3>
			</div>
		</div>
		
		<form class="form-inline">
			<div class="form-group">
				<label for="event_name">Name:</label>
				<input type="text" class="form-control" id="eventNameInput">
			</div>
			
			<!--
			<div class="form-group">
				<label for="event_time">Start Time:</label>
				<input type="time" class="form-control" id="start_time">
			</div>
			-->
		</div>
		</form>
		
		<div class="row">
			<div class="col-lg-12">
				Start Time:
				<input type="time" id="startTimeInput">
			</div>
		</div>
		
		<div class="row">
			<div class="col-lg-12">
				End Time:
				<input type="time" id="endTimeInput">
			</div>
		</div>
		
		<select class="form-control" id="dayInput">
			<option value="0">Monday</option>
			<option value="1">Tuesday</option>
			<option value="2">Wednesday</option>
			<option value="3">Thursday</option>
			<option value="4">Friday</option>
			<option value="5">Saturday</option>
			<option value="6">Sunday</option>
		</select>
		
		<div class="row">
			<div class="col-lg-12">
				Repeat Every:
			</div>
		</div>
		
		<div class="row">
			<div class="col-lg-12">
				<label class="checkbox-inline" id="repeatMon"><input type="checkbox" value="0">Mon</label>
				<label class="checkbox-inline" id="repeatTue"><input type="checkbox" value="1">Tues</label>
				<label class="checkbox-inline" id="repeatWed"><input type="checkbox" value="2">Wed</label> 
				<label class="checkbox-inline" id="repeatThu"><input type="checkbox" value="3">Thurs</label>
				<label class="checkbox-inline" id="repeatFri"><input type="checkbox" value="4">Fri</label>
				<label class="checkbox-inline" id="repeatSat"><input type="checkbox" value="5">Sat</label> 
				<label class="checkbox-inline" id="repeatSun"><input type="checkbox" value="6">Sun</label>
			</div>
		</div>
		
		<button type="button" class="btn btn-primary" id="submit_event_btn">Create</button>
	</body>
	
	<script>
	// url of webserver that will handle requests
	var HOST_URL = 'http://partrico.pythonanywhere.com'
	
	// name of user using the website TODO: READ FROM SOMEWHERE ELSE
	var USERNAME = 'stefan4472';
	
	// canvas where calendar is drawn
	var canvas = document.getElementById("calendarCanvas");
	var ctx = canvas.getContext("2d");
	
	// list of Event objects, which will be drawn to the calendar
	var events = [];
	
	// make HTTP request to get events
	loadEvents(USERNAME);
	
	// list of friends
	var friends = [];
	
	var new_event_btn = document.getElementById("submit_event_btn");
	
	// create event from entered info when user clicks submit button
	new_event_btn.onclick = function() {
		// extract fields
		var event_name = document.getElementById("eventNameInput").value;
		var start_time = document.getElementById("startTimeInput").value;
		var end_time = document.getElementById("endTimeInput").value;
		var day = document.getElementById("dayInput").value;
		
		// make sure user entered info for each field
		if (event_name === "") {
			alert("Please Enter Event Name");
		}
		else if (start_time === "") {
			alert("Please Enter Start Time");
		}
		else if (end_time === "") {
			alert("Please Enter End Time");
		}
		else {
			// parse day, start, end times from input fields and createEvent()
			var day = parseInt(day);
			
			var start_hour = parseInt(start_time.substring(0, start_time.indexOf(":")));
			var start_min = parseInt(start_time.substring(start_time.indexOf(":") + 1, start_time.length));
			
			var end_hour = parseInt(end_time.substring(0, end_time.indexOf(":")));
			var end_min = parseInt(end_time.substring(end_time.indexOf(":") + 1, end_time.length));
			
			addEvent(event_name, generateColor(), day, start_hour, start_min, end_hour, end_min);
			
			// clear fields
			document.getElementById('eventNameInput').value = '';
			document.getElementById('startTimeInput').value = '';
			document.getElementById('endTimeInput').value = '';
			
		}
	};
	
	var add_friend_btn = document.getElementById("addFriendBtn");
	
	// function makes server request and adds friend name to the list, if exists
	add_friend_btn.onclick = function() {
		
		var friend_name = document.getElementById('friendNameInput').value;
		
		// TODO: VALIDATION
		
		friends.push(friend_name);
		
		var new_checkbox = document.createElement('div');	
		new_checkbox.innerHTML = "<input type='checkbox' value='" + friend_name + "'>" + friend_name + "</input>";
		new_checkbox.onclick = function() {
			// TODO: ADD FRIEND'S DATA TO CALENDAR
		}
		document.getElementById('friendSection').appendChild(new_checkbox);
		
		// clear input box
		document.getElementById('friendNameInput').value = '';
	}
	
	// makes HTTP request to server and parses returned events, adding them to events list
	function loadEvents(username) {
		alert("Running request " + getEventsRequest(USERNAME));
		
		// create HTTP request and use generated GET request
		request_obj = new XMLHttpRequest();
		request_obj.open("GET", getEventsRequest(USERNAME), true);
		request_obj.send(null);
		
		// handle response: parse and add to events list
		request_obj.onreadystatechange = function() {
			// request is ready
			if (request_obj.readyState == 4)  { 
				prompt('Received info: ' + request_obj.responseText);
			}
		};
	}
	
	function addEvent(name, color, day, startTimeHr, startTimeMin, endTimeHr, endTimeMin) {
		alert("Creating event: " + name + " " + color + " " + day + " " + startTimeHr + ":" + startTimeMin + " to " + endTimeHr + ":" + endTimeMin);
		getUTCTime(day, startTimeHr, startTimeMin);
		// construct object
		var event = {
				name: name,
				color: color,
				day: day,
				startHour: startTimeHr,
				startMin: startTimeMin,
				endHour: endTimeHr,
				endMin: endTimeMin
			};
		
		// TODO: CHECK FOR INTERSECTS
		
		// make server request to add event
		request_obj = new XMLHttpRequest();
		request_obj.open("GET", addEventRequest(USERNAME, name, getUTCTime(day, startTimeHr, startTimeMin), getUTCTime(day, endTimeHr, endTimeMin)), true);
		request_obj.send(null);
		
		// handle response: parse and add to events list
		request_obj.onreadystatechange = function() {
			// request is ready
			if (request_obj.readyState == 4)  { 
				prompt('Received info: ' + request_obj.responseText);
			}
		};
		
		// add event and redraw calendar
		events.push(event);
		drawCalendar();
	}
	
	drawCalendar();
	
	// draws given event object to calendar
	function drawEvent(event) {
		var box_x = event.day * (canvas.width / 7);
		var box_y = canvas.height / 24.0 * event.startHour + canvas.height / 1440.0 * event.startMin;
		var box_width = canvas.width / 7;
		var box_height = canvas.height / 24.0 * (event.endHour - event.startHour) + canvas.height / 1440.0 * (event.endMin - event.startMin);
		
		// draw box
		ctx.fillStyle = event.color;
		ctx.fillRect(box_x, box_y, box_width, box_height);
		
		// draw event name centered 
		var font_size = 30;
		ctx.font = font_size + "px Arial";
		ctx.fillStyle = '#000000';
		ctx.fillText(event.name, box_x, box_y + font_size);
		ctx.fillText(event.startHour + ':' + event.startMin + ' - ' + event.endHour + ":" + event.endMin, box_x, box_y + 2 * font_size);
	}
	
	function drawCalendar() {
		var day_width = canvas.width / 7;
		var hour_height = canvas.height / 24;
		
		// draw vertical grid lines
		ctx.fillStyle = '#000000';
		for (var i = 0; i < 24; i++) {
			ctx.moveTo(0, i * hour_height);
			ctx.lineTo(canvas.width, i * hour_height);
			ctx.stroke();
		}
		
		ctx.fillStyle = '#000000';
		// draw lines separating days
		for (var i = 0; i < 8; i++) {
			ctx.moveTo(i * day_width, 0);
			ctx.lineTo(i * day_width, canvas.width);
			ctx.stroke(); 
		}
		
		for (var i = 0; i < events.length; i++) {
			drawEvent(events[i]);
		}
	}
	
	// returns UTC time (ms since Epoch) given day, hour, and minute of given week.
	// calculates based on time of previous Monday at midnight
	function getUTCTime(day, hour, minute) {
		var date = new Date();
		// get current time in ms
		var ms = date.getTime();
		prompt(ms);
		
		// subtract of ms for day of week, hour of day, minute of day to get time of midnight Monday
		ms -= date.getDay() * 86400000;
		ms -= date.getHours() * 3600000;
		ms -= date.getMinutes() * 60000;
		ms -= date.getSeconds() * 1000;
		ms -= date.getMilliseconds();
		prompt("Normed to " + ms);
		// add back times for day, hour, and minute
		return ms + day * 86400000 + hour * 3600000 + minute * 60000;
	}
	
	// returns hex string of nice, random palette color
	function generateColor() {
		var r = (Math.round(Math.random()* 127) + 127).toString(16);
		var g = (Math.round(Math.random()* 127) + 127).toString(16);
		var b = (Math.round(Math.random()* 127) + 127).toString(16);
		return '#' + r + g + b;
	}
	
	// create string request to get all friends for user
	/*function getFriendsRequest(username) {
		return 
	}*/
	
	// create string request to get all events for user
	function getEventsRequest(username) {
		return HOST_URL + "/get_events/" + username;
	}
	
	// create string request to add an event for user. Takes times in UTC
	function addEventRequest(username, event_name, start_time_utc, end_time_utc) {
		return HOST_URL + "/add_event?username=" + USERNAME + "&event_name=" + event_name + "&start_time=" + start_time_utc + "&end_time=" + end_time_utc;
		//add_event?username=stefan4472&event_name=Hackathon&start_time=1519534800&end_time=1519535800
	}
	</script>
</html>